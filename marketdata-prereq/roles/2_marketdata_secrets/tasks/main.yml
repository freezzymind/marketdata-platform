---
- name: Render marketdata DB Secret manifest
  ansible.builtin.template:
    src: secret-marketdata-db.yaml.j2
    dest: /tmp/secret-marketdata-db.yaml
    owner: root
    group: root
    mode: '0600'

- name: Apply marketdata DB Secret
  ansible.builtin.command: kubectl apply -f /tmp/secret-marketdata-db.yaml
  register: secret_apply
  changed_when: "'configured' in secret_apply.stdout or 'created' in secret_apply.stdout"
  failed_when: secret_apply.rc != 0

- name: Verify marketdata DB Secret exists
  ansible.builtin.command: kubectl -n marketdata get secret secret-marketdata-db -o name
  register: secret_check
  changed_when: false
  retries: 10
  delay: 2
  until: secret_check.rc == 0

- name: Remove temporary Secret manifest
  ansible.builtin.file:
    path: /tmp/secret-marketdata-db.yaml
    state: absent
  changed_when: false
