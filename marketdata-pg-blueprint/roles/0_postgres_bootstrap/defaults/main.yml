postgres_user: postgres
postgres_db: marketdata
pg_version: 15
pg_cluster: main
postgres_password: "{{ vault_postgres_password }}"

pg_conf_dir: "/etc/postgresql/{{ pg_version }}/{{ pg_cluster }}"
pg_conf_d_dir: "{{ pg_conf_dir }}/conf.d"
pg_tuning_file: "{{ pg_conf_d_dir }}/marketdata.conf"

pg_hba_allow_cidr: "{{ vault_pg_hba_allow_cidr }}"
pg_hba_allow_user: "{{ vault_pg_hba_allow_user }}"
pg_hba_allow_db: "{{ postgres_db }}"

# Memory
pg_shared_buffers: "1536MB"
pg_effective_cache_size: "6GB"
pg_work_mem: "8MB"
pg_maintenance_work_mem: "512MB"
pg_temp_buffers: "16MB"

# Connections
pg_max_connections: 60
pg_port: 5432
pg_listen_addresses: "{{ vault_pg_listen_addresses }}"

# WAL / Checkpoints
pg_wal_level: "replica"
pg_wal_compression: "on"
pg_max_wal_senders: 5
pg_checkpoint_timeout: "15min"
pg_max_wal_size: "1GB"
pg_min_wal_size: "256MB"

# Logging
pg_logging_collector: "on"
pg_log_directory: "log"
pg_log_filename: "postgresql.log"
pg_log_line_prefix: "%m [%p] %u@%d %h "
pg_log_statement: "ddl"
pg_log_min_duration_statement: 200

pg_log_checkpoints: "on"
pg_log_lock_waits: "on"
pg_deadlock_timeout: "1s"

# Autovacuum
pg_autovacuum: "on"
pg_autovacuum_vacuum_scale_factor: 0.05
pg_autovacuum_analyze_scale_factor: 0.02
pg_autovacuum_vacuum_cost_limit: 2000
pg_autovacuum_vacuum_cost_delay: "10ms"

# Timeouts / safety
pg_statement_timeout: "30s"
pg_idle_in_transaction_session_timeout: "60s"

# Planner / IO
pg_random_page_cost: 1.1
pg_effective_io_concurrency: 200

# Parallelism
pg_max_worker_processes: 8
pg_max_parallel_workers: 8
pg_max_parallel_workers_per_gather: 2
